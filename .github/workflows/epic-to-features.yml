name: Epic to Feature Issues Generator

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  create-feature-issues:
    runs-on: ubuntu-latest
    if: |
      github.event.issue.state == 'open' && 
      contains(github.event.comment.body, '@claude create features from epic')
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get Epic Issue Details
      id: epic-details
      run: |
        echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
        echo "issue_title=${{ github.event.issue.title }}" >> $GITHUB_OUTPUT

    - name: Ensure Feature Label Exists
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # feature ãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if ! gh label list | grep -q "^feature"; then
          echo "Creating 'feature' label..."
          gh label create feature --description "New feature implementation" --color "28a745" || true
        else
          echo "Feature label already exists"
        fi

    - name: Create Feature Issues
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        EPIC_NUMBER: ${{ steps.epic-details.outputs.issue_number }}
      run: |
        echo "ğŸš€ Creating Feature Issues for Epic #$EPIC_NUMBER..."
        
        if [ "$EPIC_NUMBER" = "2" ]; then
          echo "ğŸ“‹ Creating CI/CD Epic Features..."
          
          # ä½œæˆã—ãŸIssueç•ªå·ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
          CREATED_ISSUES=()
          
          # Feature 1: CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®š
          echo "Creating CI/CD Pipeline Issue..."
          ISSUE1_URL=$(gh issue create \
            --title "[FEAT] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®š" \
            --body-file .github/issue-templates/ci-cd-pipeline.md \
            --label "feature")
          CREATED_ISSUES+=("$ISSUE1_URL")
          
          # Feature 2: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æ§‹é€ æ§‹ç¯‰
          echo "Creating Project Structure Issue..."
          ISSUE2_URL=$(gh issue create \
            --title "[FEAT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æ§‹é€ æ§‹ç¯‰" \
            --body-file .github/issue-templates/project-structure.md \
            --label "feature")
          CREATED_ISSUES+=("$ISSUE2_URL")
          
          # Feature 3: ä¾å­˜é–¢ä¿‚ã¨ã‚³ãƒ¼ãƒ‰å“è³ªè¨­å®š
          echo "Creating Dependencies Issue..."
          ISSUE3_URL=$(gh issue create \
            --title "[FEAT] ä¾å­˜é–¢ä¿‚ã¨ã‚³ãƒ¼ãƒ‰å“è³ªè¨­å®š" \
            --body-file .github/issue-templates/dependencies-quality.md \
            --label "feature")
          CREATED_ISSUES+=("$ISSUE3_URL")
          
          # Feature 4: ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯è¨­å®š
          echo "Creating Test Framework Issue..."
          ISSUE4_URL=$(gh issue create \
            --title "[FEAT] ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯è¨­å®š" \
            --body-file .github/issue-templates/test-framework.md \
            --label "feature")
          CREATED_ISSUES+=("$ISSUE4_URL")
          
          # Feature 5: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ¢ãƒƒã‚¯ç’°å¢ƒæ§‹ç¯‰
          echo "Creating Mock Environment Issue..."
          ISSUE5_URL=$(gh issue create \
            --title "[FEAT] å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ¢ãƒƒã‚¯ç’°å¢ƒæ§‹ç¯‰" \
            --body-file .github/issue-templates/mock-environment.md \
            --label "feature")
          CREATED_ISSUES+=("$ISSUE5_URL")
          
          echo "âœ… Created ${#CREATED_ISSUES[@]} Feature Issues"
          for issue in "${CREATED_ISSUES[@]}"; do
            echo "- $issue"
          done
          
        elif [ "$EPIC_NUMBER" = "3" ]; then
          echo "ğŸ“‹ Creating RAG Implementation Epic Features..."
          echo "âš ï¸  RAG Epic features will be implemented in future version"
          
        else
          echo "âš ï¸  Unknown Epic number: $EPIC_NUMBER"
          exit 1
        fi

    - name: Comment on Epic Issue
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue comment ${{ github.event.issue.number }} \
          --body "âœ… **Feature Issuesä½œæˆå®Œäº†**

        Epic #${{ github.event.issue.number }} ã‹ã‚‰5ã¤ã®Feature Issueã‚’è‡ªå‹•ä½œæˆã—ã¾ã—ãŸï¼š
        
        ğŸ“‹ **ä½œæˆã•ã‚ŒãŸFeatures:**
        1. **[FEAT] CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è¨­å®š** - GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
        2. **[FEAT] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåŸºæœ¬æ§‹é€ æ§‹ç¯‰** - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¨è¨­å®š
        3. **[FEAT] ä¾å­˜é–¢ä¿‚ã¨ã‚³ãƒ¼ãƒ‰å“è³ªè¨­å®š** - requirements ã¨å“è³ªãƒ„ãƒ¼ãƒ«
        4. **[FEAT] ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯è¨­å®š** - pytestç’°å¢ƒæ§‹ç¯‰  
        5. **[FEAT] å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãƒ¢ãƒƒã‚¯ç’°å¢ƒæ§‹ç¯‰** - API ãƒ¢ãƒƒã‚¯è¨­å®š
        
        ğŸš€ **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:**
        1. å„Feature Issueã®å†…å®¹ç¢ºèªãƒ»èª¿æ•´
        2. é–‹ç™ºå„ªå…ˆé †ä½ã®æ±ºå®š  
        3. Claude Code Actionã§ã®å®Ÿè£…é–‹å§‹
        
        ğŸ’¡ **æ¨å¥¨å®Ÿè£…é †åº:**
        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€  â†’ ä¾å­˜é–¢ä¿‚ â†’ ãƒ†ã‚¹ãƒˆç’°å¢ƒ â†’ CI/CD â†’ ãƒ¢ãƒƒã‚¯ç’°å¢ƒ
        
        ---
        ğŸ¤– *GitHub Actions ã§è‡ªå‹•ç”Ÿæˆ*"

    - name: Handle Failure
      if: failure()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh issue comment ${{ github.event.issue.number }} \
          --body "âŒ **Feature Issuesä½œæˆã‚¨ãƒ©ãƒ¼**

        Epic #${{ github.event.issue.number }} ã‹ã‚‰ã®Feature Issueè‡ªå‹•ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚
        
        ğŸ”§ **å¯¾å‡¦æ–¹æ³•:**
        1. GitHub Actions ãƒ­ã‚°ã§è©³ç´°ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
        2. æ‰‹å‹•ã§Feature Issueã‚’ä½œæˆ
        3. ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ä¿®æ­£å¾Œã«å†å®Ÿè¡Œ
        
        ---
        ğŸ¤– *GitHub Actions ã‚¨ãƒ©ãƒ¼é€šçŸ¥*"